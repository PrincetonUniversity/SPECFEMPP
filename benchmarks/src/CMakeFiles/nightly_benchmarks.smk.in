SPECFEM_BIN = "@CMAKE_BINARY_DIR@/bin/specfem2d"
MESHFEM_BIN = "@CMAKE_BINARY_DIR@/bin/xmeshfem2D"

configfile: "@SPECFEM_BENCHMARKS_BUILD_DIR@/nightly_config.yaml"

rule all:
    input:
        profiles = expand(
            "@SPECFEM_BENCHMARKS_BUILD_DIR@/dim2/{module}/benchmark/profiles.json",
            module=[benchmark["name"] for benchmark in config["benchmarks"]]
        ),
    params:
        remote = "/home/TROMP/SPECFEMPP-benchmarks/nightly_benchmarks/data/benchmarks",
    shell:
        """
            echo "Copying benchmark results to remote server..."
            ## copy results to remote server along with date and time stamp
            ## Create a folder with current date and time
            remote="{params.remote}/$(date +'%Y%m%d_%H%M%S')"
            mkdir -p $remote
            # copy each profile.json file into separate subdirectory
            for profile in {input.profiles}; do
                module=$(basename $(dirname $(dirname $profile)))
                mkdir -p $remote/$module
                cp $profile $remote/$module/
            done
            echo "Benchmark results copied to $remote"
        """

rule profiles:
    input:
        "@SPECFEM_BENCHMARKS_BUILD_DIR@/dim2/{module}/benchmark/output.log"
    output:
        "@SPECFEM_BENCHMARKS_BUILD_DIR@/dim2/{module}/benchmark/profiles.json"
    shell:
        """
            # get hardware information
            echo -e "\n# Current Time" > {wildcards.module}_profiles.txt
            date >> {wildcards.module}_profiles.txt
            echo -e "# Benchmark: {wildcards.module}" >> {wildcards.module}_profiles.txt
            echo -e "\n# Hardware Information" >> {wildcards.module}_profiles.txt
            lscpu >> {wildcards.module}_profiles.txt
            # Extract Kokkos profiling information
            echo -e "\n# Kokkos Profiling Information" >> {wildcards.module}_profiles.txt
            profile=$(grep 'KokkosP: Kernel timing written' {input} | awk '{{print $NF}}')
            ~/kokkos-tools/profiling/simple-kernel-timer/kp_reader ${{profile}} >> {wildcards.module}_profiles.txt
            # Parse the log file to extract relevant information
            python3 @SPECFEM_BENCHMARKS_BUILD_DIR@/run_parser.py {wildcards.module}_profiles.txt -o {output}

            rm {wildcards.module}_profiles.txt
        """

for benchmark in config["benchmarks"]:
    module_name = benchmark["name"]
    alias = f'{module_name}_'
    run_solver_alias = f'{alias}run_solver'
    module:
        name: module_name
        snakefile: benchmark["snakefile"]

    use rule * from module_name as alias*

    use rule run_solver from module_name as run_solver_alias with:
        params:
            KOKKOS_TOOLS_LIBS="~/kokkos-tools/profiling/simple-kernel-timer/kp_kernel_timer.so"
        output:
            log=f"@SPECFEM_BENCHMARKS_BUILD_DIR@/dim2/{module_name}/benchmark/output.log"
